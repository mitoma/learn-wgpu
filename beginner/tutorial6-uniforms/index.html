<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Uniform buffers and a 3d camera | Learn Wgpu</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.4.0">
    
    <meta property="article:modified_time" content="2021-01-07T14:19:06.000Z"><meta property="og:site_name" content="Learn Wgpu"><meta property="og:title" content="Uniform buffers and a 3d camera"><meta property="og:type" content="website"><meta property="og:url" content="/beginner/tutorial6-uniforms/"><meta name="twitter:title" content="Uniform buffers and a 3d camera"><meta name="twitter:url" content="/beginner/tutorial6-uniforms/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label1" content="Written by"><meta name="twitter:data2" content="Benjamin R Hansen"><meta name="twitter:creator" content="https://twitter.com/sotrh760">
    <link rel="preload" href="/learn-wgpu/assets/css/0.styles.7acc6ef6.css" as="style"><link rel="preload" href="/learn-wgpu/assets/js/app.b49cbda4.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/2.71b38626.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/15.538e5927.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/22.2132e362.js" as="script"><link rel="prefetch" href="/learn-wgpu/assets/js/10.de8cadfb.js"><link rel="prefetch" href="/learn-wgpu/assets/js/11.7a6e1928.js"><link rel="prefetch" href="/learn-wgpu/assets/js/12.0331fccb.js"><link rel="prefetch" href="/learn-wgpu/assets/js/13.ab36b7e9.js"><link rel="prefetch" href="/learn-wgpu/assets/js/14.e9ee670e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/16.d5782745.js"><link rel="prefetch" href="/learn-wgpu/assets/js/17.562da89b.js"><link rel="prefetch" href="/learn-wgpu/assets/js/18.52aa5b4e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/19.ceb348b5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/20.70e640cc.js"><link rel="prefetch" href="/learn-wgpu/assets/js/21.e1893fb6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/23.1a88f225.js"><link rel="prefetch" href="/learn-wgpu/assets/js/24.7aa9a7cf.js"><link rel="prefetch" href="/learn-wgpu/assets/js/25.1c047b37.js"><link rel="prefetch" href="/learn-wgpu/assets/js/26.5180922a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/27.1f5759ac.js"><link rel="prefetch" href="/learn-wgpu/assets/js/28.ec45df5d.js"><link rel="prefetch" href="/learn-wgpu/assets/js/29.281013fa.js"><link rel="prefetch" href="/learn-wgpu/assets/js/3.83557f23.js"><link rel="prefetch" href="/learn-wgpu/assets/js/30.dc887be9.js"><link rel="prefetch" href="/learn-wgpu/assets/js/4.89cbdecc.js"><link rel="prefetch" href="/learn-wgpu/assets/js/5.5a1a3151.js"><link rel="prefetch" href="/learn-wgpu/assets/js/6.fe64e209.js"><link rel="prefetch" href="/learn-wgpu/assets/js/7.5bd078a3.js"><link rel="prefetch" href="/learn-wgpu/assets/js/8.7a7c51c2.js"><link rel="prefetch" href="/learn-wgpu/assets/js/9.ecb6e79c.js">
    <link rel="stylesheet" href="/learn-wgpu/assets/css/0.styles.7acc6ef6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu/" class="home-link router-link-active"><!----> <span class="site-name">Learn Wgpu</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu/" class="sidebar-link">Introduction</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Beginner</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/beginner/tutorial1-window/" class="sidebar-link">Dependencies and the window</a></li><li><a href="/learn-wgpu/beginner/tutorial2-swapchain/" class="sidebar-link">The Swapchain</a></li><li><a href="/learn-wgpu/beginner/tutorial3-pipeline/" class="sidebar-link">The Pipeline</a></li><li><a href="/learn-wgpu/beginner/tutorial4-buffer/" class="sidebar-link">Buffers and Indices</a></li><li><a href="/learn-wgpu/beginner/tutorial5-textures/" class="sidebar-link">Textures and bind groups</a></li><li><a href="/learn-wgpu/beginner/tutorial6-uniforms/" class="active sidebar-link">Uniform buffers and a 3d camera</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial6-uniforms/#a-perspective-camera" class="sidebar-link">A perspective camera</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial6-uniforms/#the-uniform-buffer" class="sidebar-link">The uniform buffer</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial6-uniforms/#uniform-buffers-and-bind-groups" class="sidebar-link">Uniform buffers and bind groups</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial6-uniforms/#頂点シェーダーで-uniform-を使う" class="sidebar-link">頂点シェーダーで uniform を使う</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial6-uniforms/#カメラの操作" class="sidebar-link">カメラの操作</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial6-uniforms/#challenge" class="sidebar-link">Challenge</a></li></ul></li><li><a href="/learn-wgpu/beginner/tutorial7-instancing/" class="sidebar-link">Instancing</a></li><li><a href="/learn-wgpu/beginner/tutorial8-depth/" class="sidebar-link">The Depth Buffer</a></li><li><a href="/learn-wgpu/beginner/tutorial9-models/" class="sidebar-link">Model Loading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Intermediate</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/intermediate/tutorial10-lighting/" class="sidebar-link">Working with Lights</a></li><li><a href="/learn-wgpu/intermediate/tutorial11-normals/" class="sidebar-link">Normal Mapping</a></li><li><a href="/learn-wgpu/intermediate/tutorial12-camera/" class="sidebar-link">A Better Camera</a></li><li><a href="/learn-wgpu/intermediate/tutorial13-threading/" class="sidebar-link">Multi-threading with Wgpu and Rayon</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Showcase</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/learn-wgpu/news/" class="sidebar-link">News</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="uniform-buffers-and-a-3d-camera"><a href="#uniform-buffers-and-a-3d-camera" class="header-anchor">#</a> Uniform buffers and a 3d camera</h1> <p>これまでやってきた作業はすべて2次元に見えましたが、実際にはずっと3次元で作業しています。理由の一つは <code>Vertex</code> 構造体の <code>position</code> に 3 つの float か代わりに 2 つの float を使っていたからです。そして正面からしか見ていないので、本当に 3次元 のようには見ることができません。<code>Camera</code> を作って視点を変えていきましょう。</p> <h2 id="a-perspective-camera"><a href="#a-perspective-camera" class="header-anchor">#</a> A perspective camera</h2> <p>このチュートリアルは wgpu の使い方が多くを占め、線形代数についてもチョット触れます。なので、数学について説明していきます。これについては多くの文献がオンラインにあるので、説明の詳細に興味が出てきたらそちらを参照してください。最初にすることは <code>Cargo.toml</code> に <code>cgmath = &quot;0.17&quot;</code> を加えることです。</p> <p>数学のライブラリを手に入れたので使い方を説明しましょう！<code>Camera</code> 構造体を <code>State</code> 構造体よりも上に追加しましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">Camera</span> <span class="token punctuation">{</span>
    eye<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Point3</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Point3</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    up<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    aspect<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
    fovy<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
    znear<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
    zfar<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Camera</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">build_view_projection_matrix</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.</span>
        <span class="token keyword">let</span> view <span class="token operator">=</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">look_at</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>eye<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>target<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>up<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.</span>
        <span class="token keyword">let</span> proj <span class="token operator">=</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token function">perspective</span><span class="token punctuation">(</span><span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Deg</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>fovy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>aspect<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>znear<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>zfar<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.</span>
        <span class="token keyword">return</span> <span class="token constant">OPENGL_TO_WGPU_MATRIX</span> <span class="token operator">*</span> proj <span class="token operator">*</span> view<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div> <p><code>build_view_projection_matrix</code> では魔法のようなことが起きます。</p> <ol><li><code>view</code> 行列はカメラの position(位置) と rotation(回転) によって世界の中を動きます。本質的にはカメラの逆変換行列です。</li> <li><code>proj</code> 行列はシーンの有効な奥行きをラップしたものです。これがなければオブジェクトは近くても遠くても同じ大きさになります。</li> <li>wgpu の座標系は DirectX や Metal の座標系がベースになっています。これはX軸とY軸は -1.0 から 1.0 の範囲、Z軸は0.0から1.0の範囲で<a href="https://github.com/gfx-rs/gfx/tree/master/src/backend/dx12#normalized-coordinates" target="_blank" rel="noopener noreferrer">デバイスの座標系をノーマライズする<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ことを意味しています。<code>cgmath</code> crate (そして同様に多くのゲーム用数学 crate) は OpenGL の座標系をもとに作られています。この行列は OpenGL の座標系で設定されたシーンを wgpu の座標系に変換します。その定義は以下です。</li></ol> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[rustfmt::skip]</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">OPENGL_TO_WGPU_MATRIX</span><span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
    <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
    <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
    <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
    <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <ul><li>Note: 必ずしも <code>OPENGL_TO_WGPU_MATRIX</code> は必要なものではありませんが、モデルを (0, 0, 0) に置くと半分クリッピングエリアに入ってしまいます。これはカメラの行列を使わない場合にのみ問題になります。</li></ul> <p>では <code>State</code> に <code>camera</code> を追加しましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    camera<span class="token punctuation">:</span> <span class="token class-name">Camera</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Window</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
    <span class="token comment">// let diffuse_bind_group ...</span>

    <span class="token keyword">let</span> camera <span class="token operator">=</span> <span class="token class-name">Camera</span> <span class="token punctuation">{</span>
        <span class="token comment">// position the camera one unit up and 2 units back</span>
        <span class="token comment">// +z is out of the screen</span>
        <span class="token comment">// カメラのポジションを 1 単位分上げて、2 単位分下げます。</span>
        <span class="token comment">// Z 軸の Plus 方向はカメラの後方です。</span>
        eye<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// have it look at the origin</span>
        <span class="token comment">// カメラは原点を見ます</span>
        target<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// which way is &quot;up&quot;</span>
        <span class="token comment">// どの軸が上を表すか指定します。</span>
        up<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token punctuation">::</span><span class="token function">unit_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        aspect<span class="token punctuation">:</span> sc_desc<span class="token punctuation">.</span>width <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token operator">/</span> sc_desc<span class="token punctuation">.</span>height <span class="token keyword">as</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
        fovy<span class="token punctuation">:</span> <span class="token number">45.0</span><span class="token punctuation">,</span>
        znear<span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
        zfar<span class="token punctuation">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        camera<span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>これでカメラが手に入ったので、ビュープロジェクション行列を作ることができるので、それらをどこかに配置する必要があります。そしてまた、それを何らかの方法で shader から取得する必要があります。</p> <h2 id="the-uniform-buffer"><a href="#the-uniform-buffer" class="header-anchor">#</a> The uniform buffer</h2> <p>ここまでに保存している座標やインデックスのデータ、texture をロードするために <code>Buffer</code> を使いました。それを再び利用して、uniform buffer というものを作ります。uniform はどの sharder からでも呼び出すことができる blob data です。技術的にはすでに uniform を texture や sampler のために使っています。今度はビュープロジェクション行列を保存するために使います。<code>Uniforms</code> という構造体を作りましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// We need this for Rust to store our data correctly for the shaders</span>
<span class="token comment">// sharder にデータを正確に保存するために必要です</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token comment">// This is so we can store this in a buffer</span>
<span class="token comment">// これを書くことでこの構造体を buffer に保存することができます</span>
<span class="token attribute attr-name">#[derive(Debug, Copy, Clone, bytemuck::Pod, bytemuck::Zeroable)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Uniforms</span>
    <span class="token comment">// We can't use cgmath with bytemuck directly so we'll have</span>
    <span class="token comment">// to convert the Matrix4 into a 4x4 f32 array</span>
    <span class="token comment">// cgmath を bytemuch で直接利用することはできないので、</span>
    <span class="token comment">// Matrix4 を 4 x 4 の f32 の array に変換します。</span>
    view_proj<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Uniforms</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">SquareMatrix</span><span class="token punctuation">;</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            view_proj<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">update_view_proj</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> camera<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Camera</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>view_proj <span class="token operator">=</span> camera<span class="token punctuation">.</span><span class="token function">build_view_projection_matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>データの構造はできたので <code>uniform_buffer</code> を作りましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// in new() after creating `camera`</span>

<span class="token keyword">let</span> <span class="token keyword">mut</span> uniforms <span class="token operator">=</span> <span class="token class-name">Uniforms</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
uniforms<span class="token punctuation">.</span><span class="token function">update_view_proj</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>camera<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> uniform_buffer <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_buffer_init</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span>util<span class="token punctuation">::</span></span><span class="token class-name">BufferInitDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Uniform Buffer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        contents<span class="token punctuation">:</span> <span class="token namespace">bytemuck<span class="token punctuation">::</span></span><span class="token function">cast_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span>uniforms<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferUsage</span><span class="token punctuation">::</span><span class="token constant">UNIFORM</span> <span class="token operator">|</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferUsage</span><span class="token punctuation">::</span><span class="token constant">COPY_DST</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="uniform-buffers-and-bind-groups"><a href="#uniform-buffers-and-bind-groups" class="header-anchor">#</a> Uniform buffers and bind groups</h2> <p>いいですね。 uniform buffer ができたのでこれを使って何をしましょうか。答えはこれの bind group を作るです。最初に bind group layout を作りましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> uniform_bind_group_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutDescriptor</span> <span class="token punctuation">{</span>
    entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutEntry</span> <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            visibility<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderStage</span><span class="token punctuation">::</span><span class="token constant">VERTEX</span><span class="token punctuation">,</span>
            ty<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingType</span><span class="token punctuation">::</span><span class="token class-name">UniformBuffer</span> <span class="token punctuation">{</span>
                dynamic<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                min_binding_size<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            count<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;uniform_bind_group_layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <ol><li>camera の情報は座標の操作に使うので頂点シェーダーでしか必要ありません。</li> <li><code>dynamic</code> は buffer のサイズが動的に変化するかどうかで、uniform が配列などの時に便利です。</li></ol> <p>bind group が作れるようになりました。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> uniform_bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupDescriptor</span> <span class="token punctuation">{</span>
    layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span>uniform_bind_group_layout<span class="token punctuation">,</span>
    entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">Buffer</span><span class="token punctuation">(</span>uniform_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;uniform_bind_group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <p>texture の様に <code>uniform_bind_group_layout</code> を render pipeline に登録する必要があります。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> render_pipeline_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_pipeline_layout</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PipelineLayoutDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Render Pipeline Layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        bind_group_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
            <span class="token operator">&amp;</span>texture_bind_group_layout<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>uniform_bind_group_layout<span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        push_constant_ranges<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <p><code>uniform_buffer</code> と <code>uniform_bind_group</code> を <code>State</code> に追加する必要があります。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    camera<span class="token punctuation">:</span> <span class="token class-name">Camera</span><span class="token punctuation">,</span>
    uniforms<span class="token punctuation">:</span> <span class="token class-name">Uniforms</span><span class="token punctuation">,</span>
    uniform_buffer<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Buffer</span><span class="token punctuation">,</span>
    uniform_bind_group<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Window</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        camera<span class="token punctuation">,</span>
        uniforms<span class="token punctuation">,</span>
        uniform_buffer<span class="token punctuation">,</span>
        uniform_bind_group<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>sharder に入る前に最後にやっておく必要があることは、 <code>render()</code> の中で bind group を使うことです。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>render_pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>render_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>diffuse_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// NEW!</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>uniform_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vertex_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_index_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>index_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">draw_indexed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>num_indices<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <h2 id="頂点シェーダーで-uniform-を使う"><a href="#頂点シェーダーで-uniform-を使う" class="header-anchor">#</a> 頂点シェーダーで uniform を使う</h2> <p><code>shader.vert</code> を変更します。</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">450</span></span></span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> a_position<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> a_tex_coords<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>

<span class="token comment">// NEW!</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>set<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> binding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 1.</span>
<span class="token keyword">uniform</span> Uniforms <span class="token punctuation">{</span>
    <span class="token keyword">mat4</span> u_view_proj<span class="token punctuation">;</span> <span class="token comment">// 2.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v_tex_coords <span class="token operator">=</span> a_tex_coords<span class="token punctuation">;</span>    <span class="token comment">// UPDATED!</span>
    gl_Position <span class="token operator">=</span> u_view_proj <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3.</span>
<span class="token punctuation">}</span>
</code></pre></div> <ol><li>新しい bind group を作ったのでシェーダーにそれを明示する必要があります。番号は <code>render_pipeline_layout</code> によって決定します。<code>texture_bind_group_layout</code> がリストの最初なので <code>set=0</code> で、<code>uniform_bind_group</code> が二番目なので <code>set=1</code> です。</li> <li><code>uniform</code> ブロックでは、利用するつもりのすべてのフィールドにグローバルな識別子を指定する必要があります。存在しないデータにアクセスしようとすると未定義の動作を引き起こす可能性があるので、uniform buffer で実際に使うフィールドを明確にしておくことは重要です。</li> <li>ここで掛け算の順序は重要です。ベクトルは常に右側に置き、行列は左側に置くのが重要です。</li></ol> <h2 id="カメラの操作"><a href="#カメラの操作" class="header-anchor">#</a> カメラの操作</h2> <p>もしコードを正しく記述できていれば何か以下のようなものが見れるでしょう。</p> <p><img src="/learn-wgpu/assets/img/static-tree.e1f31949.png" alt="./static-tree.png"></p> <p>形は少し伸びていますが、まだ静的です。カメラの周りをオブジェクトの周りを移動しようとすることはできますが、ほとんどのゲームは周りに動かすことができます。このチュートリアルは wgpu を使っておりユーザー入力については触れていませんでした。 <code>CameraController</code> のコードを記載します。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">CameraController</span> <span class="token punctuation">{</span>
    speed<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
    is_up_pressed<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    is_down_pressed<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    is_forward_pressed<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    is_backward_pressed<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    is_left_pressed<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    is_right_pressed<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">CameraController</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>speed<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            speed<span class="token punctuation">,</span>
            is_up_pressed<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            is_down_pressed<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            is_forward_pressed<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            is_backward_pressed<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            is_left_pressed<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            is_right_pressed<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">process_events</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> event<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">WindowEvent</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> event <span class="token punctuation">{</span>
            <span class="token class-name">WindowEvent</span><span class="token punctuation">::</span><span class="token class-name">KeyboardInput</span> <span class="token punctuation">{</span>
                input<span class="token punctuation">:</span> <span class="token class-name">KeyboardInput</span> <span class="token punctuation">{</span>
                    state<span class="token punctuation">,</span>
                    virtual_keycode<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>keycode<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">..</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">..</span>
            <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> is_pressed <span class="token operator">=</span> <span class="token operator">*</span>state <span class="token operator">==</span> <span class="token class-name">ElementState</span><span class="token punctuation">::</span><span class="token class-name">Pressed</span><span class="token punctuation">;</span>
                <span class="token keyword">match</span> keycode <span class="token punctuation">{</span>
                    <span class="token class-name">VirtualKeyCode</span><span class="token punctuation">::</span><span class="token class-name">Space</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>is_up_pressed <span class="token operator">=</span> is_pressed<span class="token punctuation">;</span>
                        <span class="token boolean">true</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">VirtualKeyCode</span><span class="token punctuation">::</span><span class="token class-name">LShift</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>is_down_pressed <span class="token operator">=</span> is_pressed<span class="token punctuation">;</span>
                        <span class="token boolean">true</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">VirtualKeyCode</span><span class="token punctuation">::</span><span class="token class-name">W</span> <span class="token operator">|</span> <span class="token class-name">VirtualKeyCode</span><span class="token punctuation">::</span><span class="token class-name">Up</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>is_forward_pressed <span class="token operator">=</span> is_pressed<span class="token punctuation">;</span>
                        <span class="token boolean">true</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">VirtualKeyCode</span><span class="token punctuation">::</span><span class="token class-name">A</span> <span class="token operator">|</span> <span class="token class-name">VirtualKeyCode</span><span class="token punctuation">::</span><span class="token class-name">Left</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>is_left_pressed <span class="token operator">=</span> is_pressed<span class="token punctuation">;</span>
                        <span class="token boolean">true</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">VirtualKeyCode</span><span class="token punctuation">::</span><span class="token class-name">S</span> <span class="token operator">|</span> <span class="token class-name">VirtualKeyCode</span><span class="token punctuation">::</span><span class="token class-name">Down</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>is_backward_pressed <span class="token operator">=</span> is_pressed<span class="token punctuation">;</span>
                        <span class="token boolean">true</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">VirtualKeyCode</span><span class="token punctuation">::</span><span class="token class-name">D</span> <span class="token operator">|</span> <span class="token class-name">VirtualKeyCode</span><span class="token punctuation">::</span><span class="token class-name">Right</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>is_right_pressed <span class="token operator">=</span> is_pressed<span class="token punctuation">;</span>
                        <span class="token boolean">true</span>
                    <span class="token punctuation">}</span>
                    _ <span class="token operator">=&gt;</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            _ <span class="token operator">=&gt;</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">update_camera</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> camera<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Camera</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">InnerSpace</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> forward <span class="token operator">=</span> camera<span class="token punctuation">.</span>target <span class="token operator">-</span> camera<span class="token punctuation">.</span>eye<span class="token punctuation">;</span>
        <span class="token keyword">let</span> forward_norm <span class="token operator">=</span> forward<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> forward_mag <span class="token operator">=</span> forward<span class="token punctuation">.</span><span class="token function">magnitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Prevents glitching when camera gets too close to the</span>
        <span class="token comment">// center of the scene.</span>
        <span class="token comment">// カメラがシーンの中心にあまりに近寄ってグリッチが発生するのを避ける。</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>is_forward_pressed <span class="token operator">&amp;&amp;</span> forward_mag <span class="token operator">&gt;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>speed <span class="token punctuation">{</span>
            camera<span class="token punctuation">.</span>eye <span class="token operator">+=</span> forward_norm <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>speed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>is_backward_pressed <span class="token punctuation">{</span>
            camera<span class="token punctuation">.</span>eye <span class="token operator">-=</span> forward_norm <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>speed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">let</span> right <span class="token operator">=</span> forward_norm<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>up<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Redo radius calc in case the up/ down is pressed.</span>
        <span class="token comment">// up / down が押されたときは角度を再計算する</span>
        <span class="token keyword">let</span> forward <span class="token operator">=</span> camera<span class="token punctuation">.</span>target <span class="token operator">-</span> camera<span class="token punctuation">.</span>eye<span class="token punctuation">;</span>
        <span class="token keyword">let</span> forward_mag <span class="token operator">=</span> forward<span class="token punctuation">.</span><span class="token function">magnitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>is_right_pressed <span class="token punctuation">{</span>
            <span class="token comment">// Rescale the distance between the target and eye so </span>
            <span class="token comment">// that it doesn't change. The eye therefore still </span>
            <span class="token comment">// lies on the circle made by the target and eye.</span>
            <span class="token comment">// 対象と視点の間の距離が変わらないよう、スケールを変更します。</span>
            <span class="token comment">// 視点は視点と対象が作った円の上にあります。</span>
            camera<span class="token punctuation">.</span>eye <span class="token operator">=</span> camera<span class="token punctuation">.</span>target <span class="token operator">-</span> <span class="token punctuation">(</span>forward <span class="token operator">+</span> right <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>speed<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> forward_mag<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>is_left_pressed <span class="token punctuation">{</span>
            camera<span class="token punctuation">.</span>eye <span class="token operator">=</span> camera<span class="token punctuation">.</span>target <span class="token operator">-</span> <span class="token punctuation">(</span>forward <span class="token operator">-</span> right <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>speed<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> forward_mag<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>このコードは完全ではありません。回転させるとカメラはゆっくりと戻ります。これで目的としては十分です。自由に修正してください。</p> <p>まだこのコードを既存のコードに接続していません。controller を <code>State</code> の <code>new()</code> で生成しましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    camera<span class="token punctuation">:</span> <span class="token class-name">Camera</span><span class="token punctuation">,</span>
    <span class="token comment">// NEW!</span>
    camera_controller<span class="token punctuation">:</span> <span class="token class-name">CameraController</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
<span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Window</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">let</span> camera_controller <span class="token operator">=</span> <span class="token class-name">CameraController</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>

        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
            camera_controller<span class="token punctuation">,</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>最後に <code>input()</code> にコードを追加します。(あなたがまだやっていないと仮定してですが)</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> event<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">WindowEvent</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>camera_controller<span class="token punctuation">.</span><span class="token function">process_events</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>この時点では、カメラコントローラーは実際には何もやりません。uniform buffer を更新する必要があります。変更にはいくつかの主要な手法があります。</p> <ol><li>別の buffer を作り、<code>uniform_buffer</code> の内容を複製します。新しい buffer は staging buffer として知られています。この手法は main buffer のコンテンツ(ここでは <code>uniform_buffer</code>)を GPU のみにアクセスできるようにします。GPU は CPU buffer にアクセスすることができないという制約の下で、いくつか速度的な最適化を行うことができます。</li> <li>もう一つの手法は buffer 自身を <code>map_read_async</code> や <code>map_write_async</code> として mapping します。これは buffer のコンテンツに直接のアクセスを許可しますが、代わりに async でそれらのメソッドを扱う必要があり buffer にも <code>BufferUsage::MAP_READ</code> や <code>BufferUsage::MAP_WRITE</code> が指定する必要があります。ここではそれらについて話しませんが <a href="../../showcase/windowless">Wgpu without a window</a> というチュートリアルをチェックすると多くのことがわかるでしょう。</li> <li><code>queue</code> で <code>write_buffer</code> を使うことができます。</li></ol> <p>ここでは三つ目の選択肢を見ていきましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">update</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>camera_controller<span class="token punctuation">.</span><span class="token function">update_camera</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>camera<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>uniforms<span class="token punctuation">.</span><span class="token function">update_view_proj</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>camera<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">write_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>uniform_buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token namespace">bytemuck<span class="token punctuation">::</span></span><span class="token function">cast_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>uniforms<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>これで必要なことはすべてです。このコードを実行すると木のテクスチャの五角形を WASD キーや矢印キーで回したりズームすることができます。</p> <h2 id="challenge"><a href="#challenge" class="header-anchor">#</a> Challenge</h2> <p>モデルをカメラとは独立して回転させてみましょう。ヒント：カメラとは別の行列が必要になるでしょう。</p> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/beginner/tutorial6-uniforms/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">1/7/2021, 11:19:06 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/learn-wgpu/beginner/tutorial5-textures/" class="prev">
          Textures and bind groups
        </a></span> <span class="next"><a href="/learn-wgpu/beginner/tutorial7-instancing/">
          Instancing
        </a>
        →
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu/assets/js/app.b49cbda4.js" defer></script><script src="/learn-wgpu/assets/js/2.71b38626.js" defer></script><script src="/learn-wgpu/assets/js/15.538e5927.js" defer></script><script src="/learn-wgpu/assets/js/22.2132e362.js" defer></script>
  </body>
</html>
