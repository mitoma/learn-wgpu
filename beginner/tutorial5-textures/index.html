<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Textures and bind groups | Learn Wgpu</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.4.0">
    
    <meta property="article:modified_time" content="2021-01-07T14:27:14.000Z"><meta property="og:site_name" content="Learn Wgpu"><meta property="og:title" content="Textures and bind groups"><meta property="og:type" content="website"><meta property="og:url" content="/beginner/tutorial5-textures/"><meta name="twitter:title" content="Textures and bind groups"><meta name="twitter:url" content="/beginner/tutorial5-textures/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label1" content="Written by"><meta name="twitter:data2" content="Benjamin R Hansen"><meta name="twitter:creator" content="https://twitter.com/sotrh760">
    <link rel="preload" href="/learn-wgpu/assets/css/0.styles.7acc6ef6.css" as="style"><link rel="preload" href="/learn-wgpu/assets/js/app.b49cbda4.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/2.71b38626.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/5.5a1a3151.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/22.2132e362.js" as="script"><link rel="prefetch" href="/learn-wgpu/assets/js/10.de8cadfb.js"><link rel="prefetch" href="/learn-wgpu/assets/js/11.7a6e1928.js"><link rel="prefetch" href="/learn-wgpu/assets/js/12.0331fccb.js"><link rel="prefetch" href="/learn-wgpu/assets/js/13.ab36b7e9.js"><link rel="prefetch" href="/learn-wgpu/assets/js/14.e9ee670e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/15.538e5927.js"><link rel="prefetch" href="/learn-wgpu/assets/js/16.d5782745.js"><link rel="prefetch" href="/learn-wgpu/assets/js/17.562da89b.js"><link rel="prefetch" href="/learn-wgpu/assets/js/18.52aa5b4e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/19.ceb348b5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/20.70e640cc.js"><link rel="prefetch" href="/learn-wgpu/assets/js/21.e1893fb6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/23.1a88f225.js"><link rel="prefetch" href="/learn-wgpu/assets/js/24.7aa9a7cf.js"><link rel="prefetch" href="/learn-wgpu/assets/js/25.1c047b37.js"><link rel="prefetch" href="/learn-wgpu/assets/js/26.5180922a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/27.1f5759ac.js"><link rel="prefetch" href="/learn-wgpu/assets/js/28.ec45df5d.js"><link rel="prefetch" href="/learn-wgpu/assets/js/29.281013fa.js"><link rel="prefetch" href="/learn-wgpu/assets/js/3.83557f23.js"><link rel="prefetch" href="/learn-wgpu/assets/js/30.dc887be9.js"><link rel="prefetch" href="/learn-wgpu/assets/js/4.89cbdecc.js"><link rel="prefetch" href="/learn-wgpu/assets/js/6.fe64e209.js"><link rel="prefetch" href="/learn-wgpu/assets/js/7.5bd078a3.js"><link rel="prefetch" href="/learn-wgpu/assets/js/8.7a7c51c2.js"><link rel="prefetch" href="/learn-wgpu/assets/js/9.ecb6e79c.js">
    <link rel="stylesheet" href="/learn-wgpu/assets/css/0.styles.7acc6ef6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu/" class="home-link router-link-active"><!----> <span class="site-name">Learn Wgpu</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu/" class="sidebar-link">Introduction</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Beginner</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/beginner/tutorial1-window/" class="sidebar-link">Dependencies and the window</a></li><li><a href="/learn-wgpu/beginner/tutorial2-swapchain/" class="sidebar-link">The Swapchain</a></li><li><a href="/learn-wgpu/beginner/tutorial3-pipeline/" class="sidebar-link">The Pipeline</a></li><li><a href="/learn-wgpu/beginner/tutorial4-buffer/" class="sidebar-link">Buffers and Indices</a></li><li><a href="/learn-wgpu/beginner/tutorial5-textures/" class="active sidebar-link">Textures and bind groups</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial5-textures/#ファイルからイメージをロードする" class="sidebar-link">ファイルからイメージをロードする</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial5-textures/#テクスチャからデータを取得する" class="sidebar-link">テクスチャからデータを取得する</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial5-textures/#textureviews-and-samplers" class="sidebar-link">TextureViews and Samplers</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial5-textures/#the-bindgroup" class="sidebar-link">The BindGroup</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial5-textures/#pipelinelayout" class="sidebar-link">PipelineLayout</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial5-textures/#vertices-を変更します。" class="sidebar-link">VERTICES を変更します。</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial5-textures/#shader-time" class="sidebar-link">Shader time</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial5-textures/#the-results" class="sidebar-link">The results</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial5-textures/#コードのクリーンアップ" class="sidebar-link">コードのクリーンアップ</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial5-textures/#challenge" class="sidebar-link">Challenge</a></li></ul></li><li><a href="/learn-wgpu/beginner/tutorial6-uniforms/" class="sidebar-link">Uniform buffers and a 3d camera</a></li><li><a href="/learn-wgpu/beginner/tutorial7-instancing/" class="sidebar-link">Instancing</a></li><li><a href="/learn-wgpu/beginner/tutorial8-depth/" class="sidebar-link">The Depth Buffer</a></li><li><a href="/learn-wgpu/beginner/tutorial9-models/" class="sidebar-link">Model Loading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Intermediate</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/intermediate/tutorial10-lighting/" class="sidebar-link">Working with Lights</a></li><li><a href="/learn-wgpu/intermediate/tutorial11-normals/" class="sidebar-link">Normal Mapping</a></li><li><a href="/learn-wgpu/intermediate/tutorial12-camera/" class="sidebar-link">A Better Camera</a></li><li><a href="/learn-wgpu/intermediate/tutorial13-threading/" class="sidebar-link">Multi-threading with Wgpu and Rayon</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Showcase</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/learn-wgpu/news/" class="sidebar-link">News</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="textures-and-bind-groups"><a href="#textures-and-bind-groups" class="header-anchor">#</a> Textures and bind groups</h1> <p>この時点で、とてもシンプルな形を描画できるようになりました。三角形だけでもゲームを作ることはできますが、物体の詳細を表現しようとするためには非常に限定的です。しかし <strong>texture</strong> を使うことでそれらの問題を回避できます。</p> <p>texture は画像を三角形のメッシュにのせてメッシュをより詳細なものに見せてくれます。テクスチャには複数のタイプがありのノーマルマップ、バンプマップ、スペキュラーマップ、ディヒューズマップなどがあります。ディヒューズマップを素人の言葉でいうと color texture ということになります。</p> <h2 id="ファイルからイメージをロードする"><a href="#ファイルからイメージをロードする" class="header-anchor">#</a> ファイルからイメージをロードする</h2> <p>イメージをメッシュにマップしようとするなら、最初に画像が必要です。このハッピーで小さな木を使いましょう。</p> <p><img src="/learn-wgpu/assets/img/happy-tree.bdff8a19.png" alt="a happy tree"></p> <p><a href="https://crates.io/crates/image" target="_blank" rel="noopener noreferrer">image crate<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> を使って木の画像をロードします。すでに依存のファーストセクションに追加されているので使うことができます。</p> <p><code>State</code> の <code>new()</code> メソッドの <code>swap_chain</code> の前に追加しましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> swap_chain <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_swap_chain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>surface<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sc_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// NEW!</span>

<span class="token keyword">let</span> diffuse_bytes <span class="token operator">=</span> <span class="token macro property">include_bytes!</span><span class="token punctuation">(</span><span class="token string">&quot;happy-tree.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> diffuse_image <span class="token operator">=</span> <span class="token namespace">image<span class="token punctuation">::</span></span><span class="token function">load_from_memory</span><span class="token punctuation">(</span>diffuse_bytes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> diffuse_rgba <span class="token operator">=</span> diffuse_image<span class="token punctuation">.</span><span class="token function">as_rgba8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token namespace">image<span class="token punctuation">::</span></span><span class="token class-name">GenericImageView</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> dimensions <span class="token operator">=</span> diffuse_image<span class="token punctuation">.</span><span class="token function">dimensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <p>これは画像ファイルからバイト列をとってき、イメージをロードした後に rgba のバイトの <code>Vec</code> に変換しています。また、画像の次元も <code>Texture</code> 生成時のために保存しておきます。</p> <p>では <code>Texture</code> を作っていきましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> texture_size <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Extent3d</span> <span class="token punctuation">{</span>
    width<span class="token punctuation">:</span> dimensions<span class="token number">.0</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> dimensions<span class="token number">.1</span><span class="token punctuation">,</span>
    depth<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> diffuse_texture <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_texture</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureDescriptor</span> <span class="token punctuation">{</span>
        <span class="token comment">// All textures are stored as 3D, we represent our 2D texture</span>
        <span class="token comment">// by setting depth to 1.</span>
        <span class="token comment">// すべてのテクスチャは三次元に配置されます。</span>
        <span class="token comment">// 二次元のテクスチャは depth 1 として表現します。</span>
        size<span class="token punctuation">:</span> texture_size<span class="token punctuation">,</span>
        mip_level_count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// We'll talk about this a little later(この項目についてはあとで説明します)</span>
        sample_count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        dimension<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureDimension</span><span class="token punctuation">::</span><span class="token constant">D2</span><span class="token punctuation">,</span>
        format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">::</span><span class="token class-name">Rgba8UnormSrgb</span><span class="token punctuation">,</span>
        <span class="token comment">// SAMPLED tells wgpu that we want to use this texture in shaders</span>
        <span class="token comment">// COPY_DST means that we want to copy data to this texture</span>
        <span class="token comment">// SAMPLED は GPU にテクスチャを sharder で使うことを教えます。</span>
        <span class="token comment">// COPY_DST はこのテクスチャにデータをコピーしてほしいということを意味しています。</span>
        usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsage</span><span class="token punctuation">::</span><span class="token constant">SAMPLED</span> <span class="token operator">|</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsage</span><span class="token punctuation">::</span><span class="token constant">COPY_DST</span><span class="token punctuation">,</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;diffuse_texture&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <h2 id="テクスチャからデータを取得する"><a href="#テクスチャからデータを取得する" class="header-anchor">#</a> テクスチャからデータを取得する</h2> <p><code>Texture</code> 構造体にはデータを直接操作するためのメソッドはありません。しかしながらテクスチャをロードしたときに <code>queue</code> の <code>write_texture</code> を呼び出すことで早く作成できます。どのようにそれを使うか見てみましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>queue<span class="token punctuation">.</span><span class="token function">write_texture</span><span class="token punctuation">(</span>
    <span class="token comment">// Tells wgpu where to copy the pixel data</span>
    <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureCopyView</span> <span class="token punctuation">{</span>
        texture<span class="token punctuation">:</span> <span class="token operator">&amp;</span>diffuse_texture<span class="token punctuation">,</span>
        mip_level<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        origin<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Origin3d</span><span class="token punctuation">::</span><span class="token constant">ZERO</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// The actual pixel data</span>
    diffuse_rgba<span class="token punctuation">,</span>
    <span class="token comment">// The layout of the texture</span>
    <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureDataLayout</span> <span class="token punctuation">{</span>
        offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        bytes_per_row<span class="token punctuation">:</span> <span class="token number">4</span> <span class="token operator">*</span> dimensions<span class="token number">.0</span><span class="token punctuation">,</span>
        rows_per_image<span class="token punctuation">:</span> dimensions<span class="token number">.1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    texture_size<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="note"><p>テクスチャにデータを書き込むには、古いやり方ではピクセルデータを buffer にコピーしてからテクスチャーにコピーしていました。<code>write_texture</code> を使うと一つのバッファしか使わないのでより効率的です。必要になる場合があるかもしれないのでここに残しておきます。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> buffer <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_buffer_init</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span>util<span class="token punctuation">::</span></span><span class="token class-name">BufferInitDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Temp Buffer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        contents<span class="token punctuation">:</span> <span class="token operator">&amp;</span>diffuse_rgba<span class="token punctuation">,</span>
        usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferUsage</span><span class="token punctuation">::</span><span class="token constant">COPY_SRC</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token keyword">mut</span> encoder <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_command_encoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">CommandEncoderDescriptor</span> <span class="token punctuation">{</span>
    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;texture_buffer_copy_encoder&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

encoder<span class="token punctuation">.</span><span class="token function">copy_buffer_to_texture</span><span class="token punctuation">(</span>
    <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferCopyView</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">:</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">,</span>
        offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        bytes_per_row<span class="token punctuation">:</span> <span class="token number">4</span> <span class="token operator">*</span> dimensions<span class="token number">.0</span><span class="token punctuation">,</span>
        rows_per_image<span class="token punctuation">:</span> dimensions<span class="token number">.1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureCopyView</span> <span class="token punctuation">{</span>
        texture<span class="token punctuation">:</span> <span class="token operator">&amp;</span>diffuse_texture<span class="token punctuation">,</span>
        mip_level<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        array_layer<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        origin<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Origin3d</span><span class="token punctuation">::</span><span class="token constant">ZERO</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    size<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

queue<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>iter<span class="token punctuation">::</span></span><span class="token function">once</span><span class="token punctuation">(</span>encoder<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <p><code>bytes_per_row</code> フィールドはいくつか考慮が必要なことがあります。この値は256の倍数である必要があります。 詳細は <a href="/learn-wgpu/showcase/gifs/#how-do-we-make-the-frames">the gif tutorial</a> をチェックしてください。</p></div> <h2 id="textureviews-and-samplers"><a href="#textureviews-and-samplers" class="header-anchor">#</a> TextureViews and Samplers</h2> <p>これで texture はデータを持つようになりましたので、使い方が必要です。<code>TextureView</code> と <code>Sampler</code> というものの出番です。 <code>TextureView</code> は texture のビューを提供します。<code>Sampler</code> は <code>Texture</code> のサンプリングの仕方をコントロールします。サンプリングは Gimp や Photoshop のスポイトツールのような役割を果たします。プログラムは与えられたテクスチャ上の座標(<strong>テクスチャ座標</strong>と言われる)を提供し、<code>Sampler</code> はそのテクスチャや内部パラメータに基づいて対応する色を返します。</p> <p><code>diffuse_texture_view</code> と <code>diffuse_sampler</code> を定義しましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// We don't need to configure the texture view much, so let's</span>
<span class="token comment">// let wgpu define it.</span>
<span class="token comment">// texture_view は wgpu が定義してくれるので、あまり設定することはありません。</span>
<span class="token keyword">let</span> diffuse_texture_view <span class="token operator">=</span> diffuse_texture<span class="token punctuation">.</span><span class="token function">create_view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDescriptor</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> diffuse_sampler <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SamplerDescriptor</span> <span class="token punctuation">{</span>
    address_mode_u<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">AddressMode</span><span class="token punctuation">::</span><span class="token class-name">ClampToEdge</span><span class="token punctuation">,</span>
    address_mode_v<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">AddressMode</span><span class="token punctuation">::</span><span class="token class-name">ClampToEdge</span><span class="token punctuation">,</span>
    address_mode_w<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">AddressMode</span><span class="token punctuation">::</span><span class="token class-name">ClampToEdge</span><span class="token punctuation">,</span>
    mag_filter<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Linear</span><span class="token punctuation">,</span>
    min_filter<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Nearest</span><span class="token punctuation">,</span>
    mipmap_filter<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Nearest</span><span class="token punctuation">,</span>
    <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <p><code>address_mode_*</code> パラメータは、sampler が texture の外の座標の外にを指定したときのふるまいを指定します。設定できる項目は3つです。</p> <ul><li><code>ClampToEdge</code> : どんなはみ出したテクスチャ座標でも、その座標に最も近いテクスチャの端の色を返します</li> <li><code>Repeat</code> : texture 座標が texture のサイズを超えたときは texture が繰り返されます</li> <li><code>MirrorRepeat</code> : <code>Repeat</code> と似ていますが、イメージの境界で反転します。</li></ul> <p><img src="/learn-wgpu/assets/img/address_mode.66a7cd1a.png" alt="address_mode.png"></p> <p><code>mag_filter</code> と <code>min_filter</code> はフラグメントが複数のピクセルをカバーするときまたは、1つのピクセルがそれぞれ複数のフラグメントが対応するときのオプションです。これは表面に近づいたり遠ざかったりするときに作用します。</p> <p>2つのオプションがあります。</p> <ul><li><code>Linear</code> : このオプションはその間にあるフラグメントをブレンドしようとするので、なめらかな表示になります。</li> <li><code>Nearest</code> : フラグメントに最も近いピクセルの色を選択します。これは遠い場合にはイメージをギザギザにしますが、近い場合にはピクセルが見えるようになります。これは、 Minecraft のようにピクセル/ボクセルを強調したゲームの場合には好ましいでしょう。</li></ul> <p>mipmap は複雑なトピックです。<a href="/todo">将来的にこのためのセクション</a>が必要です。今のところ、<code>mipmap_filter</code> は <code>mag/min_filter</code> と似ていて、どのように mipmap をブレンドするか GPU に教えると考えておけばよいでしょう。</p> <p>そのほかのフィールドについてはデフォルトの値を使います。ほかにどのようなものがあるか知りたければ <a href="https://docs.rs/wgpu/0.6.0/wgpu/struct.SamplerDescriptor.html" target="_blank" rel="noopener noreferrer">the wgpu docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> を確認してください。</p> <p>これらのリソースはとても良いものですが、どこにも接続できなければ意味がありません。 <code>BindGroup</code> と <code>PipelineLayout</code> についてみていきましょう。</p> <h2 id="the-bindgroup"><a href="#the-bindgroup" class="header-anchor">#</a> The BindGroup</h2> <p><code>BindGroup</code> は shader にリソース一式にどのようにアクセスすればいいのかを記載します。<code>BindGroup</code> を <code>BindGroupLayout</code> と使って作りましょう。最初に以下のように書きましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> texture_bind_group_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group_layout</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutDescriptor</span> <span class="token punctuation">{</span>
        entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutEntry</span> <span class="token punctuation">{</span>
                binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                visibility<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderStage</span><span class="token punctuation">::</span><span class="token constant">FRAGMENT</span><span class="token punctuation">,</span>
                ty<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingType</span><span class="token punctuation">::</span><span class="token class-name">SampledTexture</span> <span class="token punctuation">{</span>
                    multisampled<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    dimension<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDimension</span><span class="token punctuation">::</span><span class="token constant">D2</span><span class="token punctuation">,</span>
                    component_type<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureComponentType</span><span class="token punctuation">::</span><span class="token class-name">Uint</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                count<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutEntry</span> <span class="token punctuation">{</span>
                binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                visibility<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderStage</span><span class="token punctuation">::</span><span class="token constant">FRAGMENT</span><span class="token punctuation">,</span>
                ty<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingType</span><span class="token punctuation">::</span><span class="token class-name">Sampler</span> <span class="token punctuation">{</span>
                    comparison<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                count<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;texture_bind_group_layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <p><code>texture_bind_group_layout</code> は2つのエントリがあり、binding 0 はサンプリングされた texture で、binding 1 は sampler です。それぞれの binding はフラグメントシェーダーでだけ可視になるよう <code>FLAGMENT</code> を指定しています。<code>NONE</code>, <code>VERTEX</code>, <code>FRAGMENT</code>, <code>COMPUTE</code> のそれぞれの bit flat を立てて指定することが可能です。texture と sampler はほとんど常に <code>FLAGMENT</code> でだけ使われるものですが、それを知っておくことはよいことでしょう。</p> <p><code>texture_bind_group_layout</code> と一緒に <code>BindGroup</code> を作りましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> diffuse_bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupDescriptor</span> <span class="token punctuation">{</span>
        layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span>texture_bind_group_layout<span class="token punctuation">,</span>
        entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>diffuse_texture_view<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">Sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>diffuse_sampler<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;diffuse_bind_group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <p>ここでデジャヴを感じるかもしれません。<code>BindGroup</code> の多くの仕様の宣言は <code>BindGroupLayout</code> でなされているからです。なぜこれらが分かれているかという理由は、同じ <code>BindGroupLayout</code> を共有している場合は <code>BindGroup</code> に実行中のスワップアウトを可能にするためです。</p> <p>これで <code>diffuse_bind_group</code> が手に入ったので <code>State</code> に追加しましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    surface<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Surface</span><span class="token punctuation">,</span>
    device<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
    queue<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Queue</span><span class="token punctuation">,</span>
    sc_desc<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SwapChainDescriptor</span><span class="token punctuation">,</span>
    swap_chain<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SwapChain</span><span class="token punctuation">,</span>
    size<span class="token punctuation">:</span> <span class="token namespace">winit<span class="token punctuation">::</span>dpi<span class="token punctuation">::</span></span><span class="token class-name">PhysicalSize</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    colour<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Color</span><span class="token punctuation">,</span>
    render_pipeline<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipeline</span><span class="token punctuation">,</span>
    vertex_buffer<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Buffer</span><span class="token punctuation">,</span>
    index_buffer<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Buffer</span><span class="token punctuation">,</span>
    num_indicies<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    diffuse_bind_group<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And make sure we return these fields in the <code>new</code> method:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            surface<span class="token punctuation">,</span>
            device<span class="token punctuation">,</span>
            queue<span class="token punctuation">,</span>
            sc_desc<span class="token punctuation">,</span>
            swap_chain<span class="token punctuation">,</span>
            size<span class="token punctuation">,</span>
            render_pipeline<span class="token punctuation">,</span>
            vertex_buffer<span class="token punctuation">,</span>
            index_buffer<span class="token punctuation">,</span>
            num_indices<span class="token punctuation">,</span>
            <span class="token comment">// NEW!</span>
            diffuse_bind_group<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>これで <code>BindGroup</code> が得られたので <code>render()</code> 内で使うことができます。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// render()</span>
<span class="token comment">// ...</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>render_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>diffuse_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// NEW!</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vertex_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_index_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>index_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">draw_indexed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>num_indices<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="pipelinelayout"><a href="#pipelinelayout" class="header-anchor">#</a> PipelineLayout</h2> <p><code>PipelineLayout</code> を <a href="/beginner/tutorial3-pipeline#how-do-we-use-the-shaders">the pipeline section</a> で作ったことを覚えていますか？これは最後に使います。<code>PipelineLayout</code> は <code>BindGroupLayout</code> のリストを含めて使うことができます。<code>render_pipeline_layout</code> を変更して <code>texture_bind_group_layout</code> を使いましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">create_pipeline</span><span class="token punctuation">(</span>
    device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
    sc_desc<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SwapChainDescriptor</span><span class="token punctuation">,</span>
    vs_module<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderModule</span><span class="token punctuation">,</span>
    fs_module<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderModule</span><span class="token punctuation">,</span>
    texture_bind_group_layout<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayout</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipeline</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> render_pipeline_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_pipeline_layout</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PipelineLayoutDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Render Pipeline Layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
            bind_group_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">&amp;</span>texture_bind_group_layout<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
            push_constant_ranges<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div> <h2 id="vertices-を変更します。"><a href="#vertices-を変更します。" class="header-anchor">#</a> VERTICES を変更します。</h2> <p><code>Vertex</code> の定義を少し変更する必要があります。今まで <code>color</code> attribute で mesh の色を設定していました。texture を使いたいので <code>color</code> を <code>tex_coords</code> に置き換えましょう。座標は <code>Sampler</code> に渡され適切な色が取得されます。</p> <p><code>tex_coords</code> は 2 次元なので、 float の値も 3 つから 2 つになります。</p> <p>最初に <code>Vertex</code> 構造体を変更します。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Copy, Clone, Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Vertex</span> <span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>次に <code>VertexBufferDescriptor</code> に変更を反映します。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">Vertex</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">desc</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferDescriptor</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>mem<span class="token punctuation">;</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferDescriptor</span> <span class="token punctuation">{</span>
            stride<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vertex</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
            step_mode<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">InputStepMode</span><span class="token punctuation">::</span><span class="token class-name">Vertex</span><span class="token punctuation">,</span>
            attributes<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttributeDescriptor</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float3</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttributeDescriptor</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float2</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>最後に <code>VERTICES</code> 自身を変更します。今ある定義を以下のように置き換えます。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// Changed</span>
<span class="token keyword">const</span> <span class="token constant">VERTICES</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">Vertex</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
    <span class="token class-name">Vertex</span> <span class="token punctuation">{</span> position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.0868241</span><span class="token punctuation">,</span> <span class="token number">0.49240386</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.4131759</span><span class="token punctuation">,</span> <span class="token number">0.99240386</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// A</span>
    <span class="token class-name">Vertex</span> <span class="token punctuation">{</span> position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.49513406</span><span class="token punctuation">,</span> <span class="token number">0.06958647</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.0048659444</span><span class="token punctuation">,</span> <span class="token number">0.56958646</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// B</span>
    <span class="token class-name">Vertex</span> <span class="token punctuation">{</span> position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.21918549</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.44939706</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.28081453</span><span class="token punctuation">,</span> <span class="token number">0.050602943</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// C</span>
    <span class="token class-name">Vertex</span> <span class="token punctuation">{</span> position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.35966998</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3473291</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.85967</span><span class="token punctuation">,</span> <span class="token number">0.15267089</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// D</span>
    <span class="token class-name">Vertex</span> <span class="token punctuation">{</span> position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.44147372</span><span class="token punctuation">,</span> <span class="token number">0.2347359</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.9414737</span><span class="token punctuation">,</span> <span class="token number">0.7347359</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// E</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="shader-time"><a href="#shader-time" class="header-anchor">#</a> Shader time</h2> <p>新しい <code>Vertex</code> 構造体は shader にも更新が必要です。最初に <code>tex_coords</code> を vertex shader に渡すようにし、それを使い flagment shader が <code>Sampler</code> から最終的な色を得ることができるようにします。 vertex shader から行きましょう。</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token comment">// shader.vert</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">450</span></span></span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> a_position<span class="token punctuation">;</span>
<span class="token comment">// Changed</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> a_tex_coords<span class="token punctuation">;</span>

<span class="token comment">// Changed</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Changed</span>
    v_tex_coords <span class="token operator">=</span> a_tex_coords<span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>vertex shader は <code>tex_cords</code> を出力するようになったので、fragment shader はそれを取得するようにします。これらの座標があることで、最終的に sampler が texture から 色を取得できます。</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token comment">// shader.frag</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">450</span></span></span>

<span class="token comment">// Changed</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> v_tex_coords<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec4</span> f_color<span class="token punctuation">;</span>

<span class="token comment">// NEW!</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> binding <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">uniform</span> texture2D t_diffuse<span class="token punctuation">;</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> binding <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">uniform</span> sampler s_diffuse<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Changed</span>
    f_color <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span><span class="token keyword">sampler2D</span><span class="token punctuation">(</span>t_diffuse<span class="token punctuation">,</span> s_diffuse<span class="token punctuation">)</span><span class="token punctuation">,</span> v_tex_coords<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div> <p><code>t_diffuse</code> と <code>s_diffuse</code> が <code>in</code> や <code>out</code> ではなく <code>uniform</code> キーワードで定義され、layout の定義が <code>location</code> の代わりに <code>set</code> と <code>binding</code> であることに気づくでしょう。これは <code>t_diffuse</code> と <code>s_diffuse</code> はどこからでも同様に呼び出されるからです。uniform が何かということについては <a href="/learn-wgpu/beginner/tutorial6-uniforms/">cameras section</a> で深く扱います。</p> <p>現段階で知っておくべきことは <code>set = 0</code> は <code>set_bind_group()</code> の最初のパラメータに一致し、<code>binding = 0</code> は <code>BindGroupLayout</code> や <code>BindGroup</code> で定義された <code>binding</code> に関連するということです。</p> <h2 id="the-results"><a href="#the-results" class="header-anchor">#</a> The results</h2> <p>プログラムを走らせると以下のような結果になるでしょう。</p> <p><img src="/learn-wgpu/assets/img/upside-down.d50c3643.png" alt="an upside down tree on a hexagon"></p> <p>何たる運命、我らの木はひっくり返ったぞ！これは wgpu のワールド座標系は y 軸を向いているのに対してテクスチャ座礁系の y 軸は下を向いているからです。別の言葉で言い換えると、テクスチャ座標系の(0, 0)は画像の左上を指し、(1, 1)は右下を指します。</p> <p><img src="/learn-wgpu/assets/img/happy-tree-uv-coords.aa3b7d36.png" alt="happy-tree-uv-coords.png"></p> <p>三角形のそれぞれのテクスチャ座標の右側を反転させることで対応できます。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">const</span> <span class="token constant">VERTICES</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">Vertex</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
    <span class="token comment">// Changed</span>
    <span class="token class-name">Vertex</span> <span class="token punctuation">{</span> position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.0868241</span><span class="token punctuation">,</span> <span class="token number">0.49240386</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.4131759</span><span class="token punctuation">,</span> <span class="token number">0.00759614</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// A</span>
    <span class="token class-name">Vertex</span> <span class="token punctuation">{</span> position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.49513406</span><span class="token punctuation">,</span> <span class="token number">0.06958647</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.0048659444</span><span class="token punctuation">,</span> <span class="token number">0.43041354</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// B</span>
    <span class="token class-name">Vertex</span> <span class="token punctuation">{</span> position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.21918549</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.44939706</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.28081453</span><span class="token punctuation">,</span> <span class="token number">0.949397057</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// C</span>
    <span class="token class-name">Vertex</span> <span class="token punctuation">{</span> position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.35966998</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.3473291</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.85967</span><span class="token punctuation">,</span> <span class="token number">0.84732911</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// D</span>
    <span class="token class-name">Vertex</span> <span class="token punctuation">{</span> position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.44147372</span><span class="token punctuation">,</span> <span class="token number">0.2347359</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.9414737</span><span class="token punctuation">,</span> <span class="token number">0.2652641</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// E</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div> <p>これで右側の座標が反映されて五角形が適切に描かれます。</p> <p><img src="/learn-wgpu/assets/img/rightside-up.75f852e2.png" alt="our happy tree as it should be"></p> <h2 id="コードのクリーンアップ"><a href="#コードのクリーンアップ" class="header-anchor">#</a> コードのクリーンアップ</h2> <p>便利に使えるように texture のコードをモジュール化しましょう。まず <a href="https://docs.rs/anyhow/" target="_blank" rel="noopener noreferrer">anyhow<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> というエラーハンドリングをシンプルにする crate を <code>Cargo.toml</code> に追加します。</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">image</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.23&quot;</span>
<span class="token key property">winit</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.22&quot;</span>
<span class="token key property">cgmath</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.17&quot;</span>
<span class="token key property">env_logger</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.7&quot;</span>
<span class="token key property">log</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.4&quot;</span>
<span class="token key property">futures</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.3&quot;</span>
<span class="token key property">wgpu</span> <span class="token punctuation">=</span><span class="token string">&quot;0.6&quot;</span>
<span class="token key property">bytemuck</span> <span class="token punctuation">=</span> <span class="token string">&quot;1.4&quot;</span>
<span class="token key property">anyhow</span> <span class="token punctuation">=</span> <span class="token string">&quot;1.0&quot;</span> // NEW!
</code></pre></div> <p>そして <code>src/texture.rs</code> という新しいファイルに以下を追加します。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">image<span class="token punctuation">::</span></span><span class="token class-name">GenericImageView</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Texture</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> texture<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> view<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureView</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> sampler<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Sampler</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Texture</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_bytes</span><span class="token punctuation">(</span>
        device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
        queue<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Queue</span><span class="token punctuation">,</span>
        bytes<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        label<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> img <span class="token operator">=</span> <span class="token namespace">image<span class="token punctuation">::</span></span><span class="token function">load_from_memory</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">from_image</span><span class="token punctuation">(</span>device<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>img<span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_image</span><span class="token punctuation">(</span>
        device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
        queue<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Queue</span><span class="token punctuation">,</span>
        img<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">image<span class="token punctuation">::</span></span><span class="token class-name">DynamicImage</span><span class="token punctuation">,</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> rgba <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function">as_rgba8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> dimensions <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function">dimensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> size <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Extent3d</span> <span class="token punctuation">{</span>
            width<span class="token punctuation">:</span> dimensions<span class="token number">.0</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> dimensions<span class="token number">.1</span><span class="token punctuation">,</span>
            depth<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> texture <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_texture</span><span class="token punctuation">(</span>
            <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureDescriptor</span> <span class="token punctuation">{</span>
                label<span class="token punctuation">,</span>
                size<span class="token punctuation">,</span>
                mip_level_count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                sample_count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                dimension<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureDimension</span><span class="token punctuation">::</span><span class="token constant">D2</span><span class="token punctuation">,</span>
                format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">::</span><span class="token class-name">Rgba8UnormSrgb</span><span class="token punctuation">,</span>
                usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsage</span><span class="token punctuation">::</span><span class="token constant">SAMPLED</span> <span class="token operator">|</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsage</span><span class="token punctuation">::</span><span class="token constant">COPY_DST</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        queue<span class="token punctuation">.</span><span class="token function">write_texture</span><span class="token punctuation">(</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureCopyView</span> <span class="token punctuation">{</span>
                texture<span class="token punctuation">:</span> <span class="token operator">&amp;</span>texture<span class="token punctuation">,</span>
                mip_level<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                origin<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Origin3d</span><span class="token punctuation">::</span><span class="token constant">ZERO</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            rgba<span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureDataLayout</span> <span class="token punctuation">{</span>
                offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                bytes_per_row<span class="token punctuation">:</span> <span class="token number">4</span> <span class="token operator">*</span> dimensions<span class="token number">.0</span><span class="token punctuation">,</span>
                rows_per_image<span class="token punctuation">:</span> dimensions<span class="token number">.1</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            size<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> view <span class="token operator">=</span> texture<span class="token punctuation">.</span><span class="token function">create_view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDescriptor</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> sampler <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_sampler</span><span class="token punctuation">(</span>
            <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SamplerDescriptor</span> <span class="token punctuation">{</span>
                address_mode_u<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">AddressMode</span><span class="token punctuation">::</span><span class="token class-name">ClampToEdge</span><span class="token punctuation">,</span>
                address_mode_v<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">AddressMode</span><span class="token punctuation">::</span><span class="token class-name">ClampToEdge</span><span class="token punctuation">,</span>
                address_mode_w<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">AddressMode</span><span class="token punctuation">::</span><span class="token class-name">ClampToEdge</span><span class="token punctuation">,</span>
                mag_filter<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Linear</span><span class="token punctuation">,</span>
                min_filter<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Nearest</span><span class="token punctuation">,</span>
                mipmap_filter<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Nearest</span><span class="token punctuation">,</span>
                <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">Self</span> <span class="token punctuation">{</span> texture<span class="token punctuation">,</span> view<span class="token punctuation">,</span> sampler <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div> <p><code>CommandBuffer</code> を texture と一緒に返しています。これは複数のテクスチャを同時にロードし、複数の command buffer の submit を一度に行えるということを意味しています。</p> <p>これを使うためには <code>texture.rs</code> module を <code>main.rs</code> のトップで import する必要があります。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">mod</span> <span class="token module-declaration namespace">texture</span><span class="token punctuation">;</span>
</code></pre></div> <p>texture を作るコードを <code>new()</code> に入れるのはとてもシンプルになりました。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> swap_chain <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_swap_chain</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>surface<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sc_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> diffuse_bytes <span class="token operator">=</span> <span class="token macro property">include_bytes!</span><span class="token punctuation">(</span><span class="token string">&quot;happy-tree.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// CHANGED!</span>
<span class="token keyword">let</span> diffuse_texture <span class="token operator">=</span> <span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">::</span><span class="token function">from_bytes</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>device<span class="token punctuation">,</span> <span class="token operator">&amp;</span>queue<span class="token punctuation">,</span> diffuse_bytes<span class="token punctuation">,</span> <span class="token string">&quot;happy-tree.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// CHANGED!</span>

<span class="token comment">// Everything up until `let texture_bind_group_layout = ...` can now be removed.</span>
</code></pre></div> <p><code>Texture</code> が <code>BindGroup</code> がどのようにレイアウトするのか知る必要がないように、bind group は分けて保存する必要があります。<code>diffuse_bind_group</code> を作るところは <code>view</code> と <code>sampler</code> が <code>diffuse_texture</code> のものになるなど少し変わります。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> diffuse_bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupDescriptor</span> <span class="token punctuation">{</span>
        layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span>texture_bind_group_layout<span class="token punctuation">,</span>
        entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>diffuse_texture<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// CHANGED!</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">Sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>diffuse_texture<span class="token punctuation">.</span>sampler<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// CHANGED!</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;diffuse_bind_group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <p>最後に新しい <code>Texture</code> 構造体をチュートリアルで使うために <code>State</code> フィールドに変更を加えます。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    diffuse_bind_group<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">,</span>
    diffuse_texture<span class="token punctuation">:</span> <span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">,</span> <span class="token comment">// NEW</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
            num_indices<span class="token punctuation">,</span>
            diffuse_bind_group<span class="token punctuation">,</span>
            diffuse_texture<span class="token punctuation">,</span> <span class="token comment">// NEW</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>なんと!</p> <p>これらの変更をくわえてもコードはそれまでと同じように動きますが、テクスチャを作るのはとても容易になりました。</p> <h2 id="challenge"><a href="#challenge" class="header-anchor">#</a> Challenge</h2> <p>もう一つ別の texture を作ってスペースキーで切り替えれるようにしてみましょう。</p> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/beginner/tutorial5-textures/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">1/7/2021, 11:27:14 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/learn-wgpu/beginner/tutorial4-buffer/" class="prev">
          Buffers and Indices
        </a></span> <span class="next"><a href="/learn-wgpu/beginner/tutorial6-uniforms/">
          Uniform buffers and a 3d camera
        </a>
        →
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu/assets/js/app.b49cbda4.js" defer></script><script src="/learn-wgpu/assets/js/2.71b38626.js" defer></script><script src="/learn-wgpu/assets/js/5.5a1a3151.js" defer></script><script src="/learn-wgpu/assets/js/22.2132e362.js" defer></script>
  </body>
</html>
