<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>The Pipeline | Learn Wgpu</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.4.0">
    
    <meta property="article:modified_time" content="2021-01-07T14:19:06.000Z"><meta property="og:site_name" content="Learn Wgpu"><meta property="og:title" content="The Pipeline"><meta property="og:type" content="website"><meta property="og:url" content="/beginner/tutorial3-pipeline/"><meta name="twitter:title" content="The Pipeline"><meta name="twitter:url" content="/beginner/tutorial3-pipeline/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label1" content="Written by"><meta name="twitter:data2" content="Benjamin R Hansen"><meta name="twitter:creator" content="https://twitter.com/sotrh760">
    <link rel="preload" href="/learn-wgpu/assets/css/0.styles.7acc6ef6.css" as="style"><link rel="preload" href="/learn-wgpu/assets/js/app.b49cbda4.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/2.71b38626.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/12.0331fccb.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/22.2132e362.js" as="script"><link rel="prefetch" href="/learn-wgpu/assets/js/10.de8cadfb.js"><link rel="prefetch" href="/learn-wgpu/assets/js/11.7a6e1928.js"><link rel="prefetch" href="/learn-wgpu/assets/js/13.ab36b7e9.js"><link rel="prefetch" href="/learn-wgpu/assets/js/14.e9ee670e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/15.538e5927.js"><link rel="prefetch" href="/learn-wgpu/assets/js/16.d5782745.js"><link rel="prefetch" href="/learn-wgpu/assets/js/17.562da89b.js"><link rel="prefetch" href="/learn-wgpu/assets/js/18.52aa5b4e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/19.ceb348b5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/20.70e640cc.js"><link rel="prefetch" href="/learn-wgpu/assets/js/21.e1893fb6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/23.1a88f225.js"><link rel="prefetch" href="/learn-wgpu/assets/js/24.7aa9a7cf.js"><link rel="prefetch" href="/learn-wgpu/assets/js/25.1c047b37.js"><link rel="prefetch" href="/learn-wgpu/assets/js/26.5180922a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/27.1f5759ac.js"><link rel="prefetch" href="/learn-wgpu/assets/js/28.ec45df5d.js"><link rel="prefetch" href="/learn-wgpu/assets/js/29.281013fa.js"><link rel="prefetch" href="/learn-wgpu/assets/js/3.83557f23.js"><link rel="prefetch" href="/learn-wgpu/assets/js/30.dc887be9.js"><link rel="prefetch" href="/learn-wgpu/assets/js/4.89cbdecc.js"><link rel="prefetch" href="/learn-wgpu/assets/js/5.5a1a3151.js"><link rel="prefetch" href="/learn-wgpu/assets/js/6.fe64e209.js"><link rel="prefetch" href="/learn-wgpu/assets/js/7.5bd078a3.js"><link rel="prefetch" href="/learn-wgpu/assets/js/8.7a7c51c2.js"><link rel="prefetch" href="/learn-wgpu/assets/js/9.ecb6e79c.js">
    <link rel="stylesheet" href="/learn-wgpu/assets/css/0.styles.7acc6ef6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu/" class="home-link router-link-active"><!----> <span class="site-name">Learn Wgpu</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu/" class="sidebar-link">Introduction</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Beginner</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/beginner/tutorial1-window/" class="sidebar-link">Dependencies and the window</a></li><li><a href="/learn-wgpu/beginner/tutorial2-swapchain/" class="sidebar-link">The Swapchain</a></li><li><a href="/learn-wgpu/beginner/tutorial3-pipeline/" class="active sidebar-link">The Pipeline</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial3-pipeline/#pipeline-とは何ですか？" class="sidebar-link">pipeline とは何ですか？</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial3-pipeline/#待って、シェーダーって？" class="sidebar-link">待って、シェーダーって？</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial3-pipeline/#頂点、フラグメント…。それは何ですか？" class="sidebar-link">頂点、フラグメント…。それは何ですか？</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial3-pipeline/#glsl-と-spir-v" class="sidebar-link">GLSL と SPIR-V</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial3-pipeline/#シェーダーを書く" class="sidebar-link">シェーダーを書く</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial3-pipeline/#シェーダーはどのように使うか" class="sidebar-link">シェーダーはどのように使うか</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial3-pipeline/#パイプラインを使う" class="sidebar-link">パイプラインを使う</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial3-pipeline/#sheder-のコンパイルと-include-spirv" class="sidebar-link">sheder のコンパイルと include_spirv</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial3-pipeline/#challenge" class="sidebar-link">Challenge</a></li></ul></li><li><a href="/learn-wgpu/beginner/tutorial4-buffer/" class="sidebar-link">Buffers and Indices</a></li><li><a href="/learn-wgpu/beginner/tutorial5-textures/" class="sidebar-link">Textures and bind groups</a></li><li><a href="/learn-wgpu/beginner/tutorial6-uniforms/" class="sidebar-link">Uniform buffers and a 3d camera</a></li><li><a href="/learn-wgpu/beginner/tutorial7-instancing/" class="sidebar-link">Instancing</a></li><li><a href="/learn-wgpu/beginner/tutorial8-depth/" class="sidebar-link">The Depth Buffer</a></li><li><a href="/learn-wgpu/beginner/tutorial9-models/" class="sidebar-link">Model Loading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Intermediate</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/intermediate/tutorial10-lighting/" class="sidebar-link">Working with Lights</a></li><li><a href="/learn-wgpu/intermediate/tutorial11-normals/" class="sidebar-link">Normal Mapping</a></li><li><a href="/learn-wgpu/intermediate/tutorial12-camera/" class="sidebar-link">A Better Camera</a></li><li><a href="/learn-wgpu/intermediate/tutorial13-threading/" class="sidebar-link">Multi-threading with Wgpu and Rayon</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Showcase</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/learn-wgpu/news/" class="sidebar-link">News</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="the-pipeline"><a href="#the-pipeline" class="header-anchor">#</a> The Pipeline</h1> <h2 id="pipeline-とは何ですか？"><a href="#pipeline-とは何ですか？" class="header-anchor">#</a> pipeline とは何ですか？</h2> <p>もし OpenGL になじみがあれば、シェーダープログラムのことを思い出すかもしれません。pipeline についてはそれの頑強なバージョンだと考えることができます。pipeline は GPU がデータを受け取ったときに行うアクションすべてを表現するものです。このセクションでは <code>RdenderPipeline</code> を具体的に作っていきます。</p> <h2 id="待って、シェーダーって？"><a href="#待って、シェーダーって？" class="header-anchor">#</a> 待って、シェーダーって？</h2> <p>シェーダーとはデータを処理するために GPU に送信される小さなプログラムです。シェーダーには大きく3つのタイプがあります。頂点シェーダー、フラグメントシェーダー、コンビュートシェーダーです。他にもジオメトリシェーダーなどもありますが、これはより進んだトピックになります。今は頂点シェーダーとフラグメントシェーダーについて扱います。</p> <h2 id="頂点、フラグメント…。それは何ですか？"><a href="#頂点、フラグメント…。それは何ですか？" class="header-anchor">#</a> 頂点、フラグメント…。それは何ですか？</h2> <p>頂点とは三次元空間における(または二次元空間における)点です。頂点は2つの組で線を形づくり、3つの組で三角を形づくります。</p> <img src="/learn-wgpu/assets/img/tutorial3-pipeline-vertices.5e39e8fc.png"> <p>ほとんどの現代的なレンダリングでは、簡単なもの(例えば立方体)から複雑なもの(例えば人々)まで三角形ですべて構成されています。</p> <p>私たちは頂点シェーダー使うことですべての頂点を操作し、やりたいように変形したりします。</p> <p>フラグメントの事は、最初は結果イメージの各ピクセルの事だと考えることができます。それぞれのフラグメントは対応するピクセルにコピーされる色を持っています。フラグメントシェーダーはフラグメントがどの色になるか決定します。</p> <h2 id="glsl-と-spir-v"><a href="#glsl-と-spir-v" class="header-anchor">#</a> GLSL と SPIR-V</h2> <p><code>wgpu</code> におけるシェーダーは <a href="https://www.khronos.org/registry/spir-v/" target="_blank" rel="noopener noreferrer">SPIR-V<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> と呼ばれるバイナリ言語で書かれています。SPIR-V はコンピュータ可読にデザインされており、人間が読むものではないので、GLSL という言語でコードを書き SPIR-V にコンバートします。(具体的にいうと、<code>wgpu</code> では <a href="https://github.com/KhronosGroup/GLSL/blob/master/extensions/khr/GL_KHR_vulkan_glsl.txt" target="_blank" rel="noopener noreferrer">Valkan 方言の GLSL<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> を使います)</p> <p>それをするためには少し変更点があります。crate の依存に追加するのものがあるのです。</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token comment"># ...</span>
<span class="token key property">shaderc</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.6&quot;</span>
</code></pre></div> <p>これを少し使って最初にシェーダーを作ってみましょう。</p> <h2 id="シェーダーを書く"><a href="#シェーダーを書く" class="header-anchor">#</a> シェーダーを書く</h2> <p><code>main.rs</code> と同じフォルダに <code>shader.vert</code> と <code>sharder.flag</code> という 2 つのファイルを作りましょう。<code>sharder.vert</code> は次のような感じです。</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token comment">// shader.vert</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">450</span></span></span>

<span class="token keyword">const</span> <span class="token keyword">vec2</span> positions<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">vec2</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
    <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>positions<span class="token punctuation">[</span>gl_VertexIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>もし C/C++ や Java を以前使ったことがあればこの文法はいくらか親しみがあるでしょう。後で説明しますがいくつか重要な違いがあります。</p> <p>最初に <code>#version 450</code> という行があります。これは使用する GLSL のバージョンを明確にしています。いくつかこのバージョン以降のアドバンスドな GLSL の機能を使います。</p> <p>現時点ではシェーダーの中に頂点の情報を <code>positions</code> として保存しています。これはシェーダーに何か描画させるときにはよくないやり方で、複雑なモデルを描こうとするとシェーダーが非常に大きくなってしまいます。実際の頂点データを使うときには <code>Buffer</code> を使いますし、それは次回説明しますが、今は目をつぶりましょう。</p> <p><code>gl_Position</code> と <code>gl_VertexIndex</code> はビルトインの変数で、 <code>gl_Position</code> は座標の位置を表す4つのfloatの値を保存し、<code>gl_vertexIndex</code> は座標のデータのうち現在の座標のindexを表しています。</p> <p>次に <code>shader.flag</code> を見てみましょう。</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token comment">// shader.frag</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">450</span></span></span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec4</span> f_color<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    f_color <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>ここで突出しているのは <code>layout(location=0) out vec4 f_color;</code> という行でしょう。GLSL ではシェーダー内に <code>in</code> 変数と <code>out</code> 変数を作ります。<code>in</code> 変数はシェーダーの外から渡されるデータを期待しています。頂点シェーダーにおいては頂点データが渡されます。フラグメントシェーダーでは頂点シェーダーの <code>out</code> 変数として出力されたデータが <code>in</code> 変数として取られます。フラグメントシェーダーで <code>out</code> 変数が定義されるとき、その値はシェーダープログラムの外で使われる値ということを意味します。</p> <p><code>in</code> と <code>out</code> の変数はレイアウトも明記します。<code>sharder.flag</code> では <code>out vec4 f_clolor</code> は <code>layout(location=0)</code> と記述されており、<code>f_color</code> は私たちのアプリケーションの0番目の位置のバッファに保存されます。ほとんどのケースでは <code>location=0</code> は swapchain の現在の texture 、すなわちスクリーンです。</p> <p><code>sharder.vert</code> は <code>in</code> 変数も <code>out</code> 変数も持っていないことに気づくかもしれません。 <code>gl_Position</code> は頂点位置データの出力するための変数ときて機能するので <code>sharder.vert</code> では出力変数を必要としません。もし、フラグメントシェーダーに座標データ以外のほかの変数を渡したい場合に <code>shader.vert</code> に <code>out</code> 変数を定義してやり <code>shader.flag</code> に <code>in</code> 変数を定義してやります。
Note: location が一致しないと GLSL コードはコンパイルに失敗します。</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token comment">// shader.vert</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">out</span> <span class="token keyword">vec4</span> v_color<span class="token punctuation">;</span>

<span class="token comment">// shader.frag</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>location<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec4</span> v_color<span class="token punctuation">;</span>
</code></pre></div> <h2 id="シェーダーはどのように使うか"><a href="#シェーダーはどのように使うか" class="header-anchor">#</a> シェーダーはどのように使うか</h2> <p>このパートで最終的に成し遂げることは、pipline の構築です。最初に <code>State</code> を修正しましょう。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// main.rs</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    surface<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Surface</span><span class="token punctuation">,</span>
    device<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
    queue<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Queue</span><span class="token punctuation">,</span>
    sc_desc<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SwapChainDescriptor</span><span class="token punctuation">,</span>
    swap_chain<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SwapChain</span><span class="token punctuation">,</span>
    size<span class="token punctuation">:</span> <span class="token namespace">winit<span class="token punctuation">::</span>dpi<span class="token punctuation">::</span></span><span class="token class-name">PhysicalSize</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">// NEW!</span>
    render_pipeline<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipeline</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>pipeline を作るために最初に <code>new()</code> を見ていきましょう。<code>render_pipeline</code> にはシェーダーが必要なので、それを作る前にシェーダーをロードしなければいけません。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> vs_src <span class="token operator">=</span> <span class="token macro property">include_str!</span><span class="token punctuation">(</span><span class="token string">&quot;shader.vert&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fs_src <span class="token operator">=</span> <span class="token macro property">include_str!</span><span class="token punctuation">(</span><span class="token string">&quot;shader.frag&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> compiler <span class="token operator">=</span> <span class="token namespace">shaderc<span class="token punctuation">::</span></span><span class="token class-name">Compiler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> vs_spirv <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">compile_into_spirv</span><span class="token punctuation">(</span>vs_src<span class="token punctuation">,</span> <span class="token namespace">shaderc<span class="token punctuation">::</span></span><span class="token class-name">ShaderKind</span><span class="token punctuation">::</span><span class="token class-name">Vertex</span><span class="token punctuation">,</span> <span class="token string">&quot;shader.vert&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fs_spirv <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">compile_into_spirv</span><span class="token punctuation">(</span>fs_src<span class="token punctuation">,</span> <span class="token namespace">shaderc<span class="token punctuation">::</span></span><span class="token class-name">ShaderKind</span><span class="token punctuation">::</span><span class="token class-name">Fragment</span><span class="token punctuation">,</span> <span class="token string">&quot;shader.frag&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span> <span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> vs_module <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_shader_module</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span>util<span class="token punctuation">::</span></span><span class="token function">make_spirv</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vs_spirv<span class="token punctuation">.</span><span class="token function">as_binary_u8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fs_module <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_shader_module</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span>util<span class="token punctuation">::</span></span><span class="token function">make_spirv</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fs_spirv<span class="token punctuation">.</span><span class="token function">as_binary_u8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <p>もう一つ、 <code>PipelineLayout</code> も作らないといけません。これは後で <code>Buffer</code> を作るときに必要になってきます。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> render_pipeline_layout <span class="token operator">=</span>
    device<span class="token punctuation">.</span><span class="token function">create_pipeline_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PipelineLayoutDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Render Pipeline Layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        bind_group_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        push_constant_ranges<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <p>最終的に私たちが必要な <code>render_pipeline</code> は以下のようになります。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> render_pipeline <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_render_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipelineDescriptor</span> <span class="token punctuation">{</span>
    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Render Pipeline&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    layout<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>render_pipeline_layout<span class="token punctuation">)</span><span class="token punctuation">,</span>
    vertex_stage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ProgrammableStageDescriptor</span> <span class="token punctuation">{</span>
        module<span class="token punctuation">:</span> <span class="token operator">&amp;</span>vs_module<span class="token punctuation">,</span>
        entry_point<span class="token punctuation">:</span> <span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 1.</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    fragment_stage<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ProgrammableStageDescriptor</span> <span class="token punctuation">{</span> <span class="token comment">// 2.</span>
        module<span class="token punctuation">:</span> <span class="token operator">&amp;</span>fs_module<span class="token punctuation">,</span>
        entry_point<span class="token punctuation">:</span> <span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// continued ...</span>
</code></pre></div> <p>2点注意事項があります。</p> <ol><li>シェーダーの <code>entry_point</code> を明記する必要があります。私はたいてい OpenGL では <code>main</code> を使っていました。しかし名前はあなたが希望するものであればなんでもかまいません。</li> <li><code>fragment_stage</code> は技術的には Optional (あってもなくてもよい)なので <code>Some()</code> でラップしてます。私は頂点シェーダーをフラグメントシェーダーなしで使ったことはありませんが、もし必要なら使わないという選択もできます。</li></ol> <div class="language-rust extra-class"><pre class="language-rust"><code>    rasterization_state<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RasterizationStateDescriptor</span> <span class="token punctuation">{</span>
            front_face<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FrontFace</span><span class="token punctuation">::</span><span class="token class-name">Ccw</span><span class="token punctuation">,</span>
            cull_mode<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">CullMode</span><span class="token punctuation">::</span><span class="token class-name">Back</span><span class="token punctuation">,</span>
            depth_bias<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            depth_bias_slope_scale<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
            depth_bias_clamp<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
            clamp_depth<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// continued ...</span>
</code></pre></div> <p><code>rasterization_state</code> はフラグメントシェーダー(やそれがない場合には次のステージのパイプラインに)にデータを送る前にどのようにプリミティブを処理するかを記述します。(ここでは三角形をどう扱うか)プリミティブは基準に合わなければ取り除かれます。(つまり描画されません)。カリングは見えてはいけないものを描画しないので、レンダリングプロセスをスピードアップさせる助けになります。</p> <p>カリングについては <code>Buffer</code> の項でさらに触れます。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>    color_states<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ColorStateDescriptor</span> <span class="token punctuation">{</span>
            format<span class="token punctuation">:</span> sc_desc<span class="token punctuation">.</span>format<span class="token punctuation">,</span>
            color_blend<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BlendDescriptor</span><span class="token punctuation">::</span><span class="token constant">REPLACE</span><span class="token punctuation">,</span>
            alpha_blend<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BlendDescriptor</span><span class="token punctuation">::</span><span class="token constant">REPLACE</span><span class="token punctuation">,</span>
            write_mask<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ColorWrite</span><span class="token punctuation">::</span><span class="token constant">ALL</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// continued ...</span>
</code></pre></div> <p><code>color_state</code> はパイプライン中でどのように色が保存されたり処理されるかを記述します。複数の color state を用意することができますが、スクリーンに描画するには一つだけあればよいでしょう。<code>swap_chain</code> のフォーマットをコピーするのが簡単ですし、色のブレンディングは古いピクセルデータを新しいものでリプレースするだけでよいでしょう。また GPU には 青、赤、黄色、透明度のすべての値を書き込むようにしています。テクスチャについては話すときに　<code>color_state</code> についてもう少し触れます。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>    primitive_topology<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PrimitiveTopology</span><span class="token punctuation">::</span><span class="token class-name">TriangleList</span><span class="token punctuation">,</span> <span class="token comment">// 1.</span>
    depth_stencil_state<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span> <span class="token comment">// 2.</span>
    vertex_state<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexStateDescriptor</span> <span class="token punctuation">{</span>
        index_format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">IndexFormat</span><span class="token punctuation">::</span><span class="token class-name">Uint16</span><span class="token punctuation">,</span> <span class="token comment">// 3.</span>
        vertex_buffers<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 4.</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    sample_count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 5.</span>
    sample_mask<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 6.</span>
    alpha_to_coverage_enabled<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 7.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div> <p>残りのメソッドはシンプルです。</p> <ol><li><code>wgpu</code> に描画のために三角形を使うと教えます</li> <li>今はデプス・ステンシルバッファを使いませんので、<code>depth_stencil_state</code> には <code>None</code> を指定します。ここは後で変えます。</li> <li>インデックスに使う型を指定します。ここでは16bit符号なし整数です。 <code>Buffer</code> で触れます。</li> <li><code>vertex_buffers</code> はあなたも想像したでしょうがとても大きなトピックで、 <code>Buffer</code> で触れます。</li> <li>ここではパイプラインでいくつのサンプルを扱うか決めます。マルチサンプリングは複雑なトピックでここでは扱いません。</li> <li><code>sample_mask</code> はサンプルがアクティブかどうか明記します。ここではすべてアクティブとしています。</li> <li><code>alpha_to_coverage_enabled</code> はアンチエイリアシングです。私たちはアンチエイリアシングをここではカバーしないので今は false を指定します。</li></ol> <p>これで <code>render_pipeline</code> を　<code>State</code> に追加できたので使えます！</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// new()</span>
<span class="token keyword">Self</span> <span class="token punctuation">{</span>
    surface<span class="token punctuation">,</span>
    device<span class="token punctuation">,</span>
    queue<span class="token punctuation">,</span>
    size<span class="token punctuation">,</span>
    sc_desc<span class="token punctuation">,</span>
    swap_chain<span class="token punctuation">,</span>
    <span class="token comment">// NEW!</span>
    render_pipeline<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div> <h2 id="パイプラインを使う"><a href="#パイプラインを使う" class="header-anchor">#</a> パイプラインを使う</h2> <p>もしプログラムを今走らせると、起動には少し時間がかかるでしょうが、まだ前のセクションで実装した青いスクリーンが表示されるでしょう。これは　<code>render_pipeline</code> を作りましたが、実際に使うには <code>render()</code> に修正が必要なためです。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// render()</span>

<span class="token comment">// ...</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 1.</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> render_pass <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">begin_render_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassDescriptor</span> <span class="token punctuation">{</span>
        color_attachments<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassColorAttachmentDescriptor</span> <span class="token punctuation">{</span>
                attachment<span class="token punctuation">:</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">.</span>view<span class="token punctuation">,</span>
                resolve_target<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                ops<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Operations</span> <span class="token punctuation">{</span>
                    load<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">LoadOp</span><span class="token punctuation">::</span><span class="token class-name">Clear</span><span class="token punctuation">(</span>
                        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Color</span> <span class="token punctuation">{</span>
                            r<span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
                            g<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
                            b<span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token punctuation">,</span>
                            a<span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">)</span><span class="token punctuation">,</span>
                    store<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        depth_stencil_attachment<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// NEW!</span>
    render_pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>render_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2.</span>
    render_pass<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3.</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
</code></pre></div> <p>大きな変更はありませんが、変更点についてみていきましょう。</p> <ol><li><code>_render_pass</code> が　<code>render_pass</code> に変更され mutable になりました</li> <li><code>render_pass</code> に先ほど作った pipeline がセットしました</li> <li><code>wgpu</code> に3つの座標があり1つのインスタンスがあると伝えています。これがgl_VertexIndexの出所です。</li></ol> <p>すべてやり終えると愛らしい茶色の三角形が出てきます。</p> <p><img src="data:image/png;base64,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Io8++misWLFi0McDAAA0wDPPPHPxrVljY2O+WR0AAEgzHNHb764HAACYzxw/pxEAAKC/3BEBAADSDUdE/MPf/t6gjwMAAGiI3Rtb3poFAADkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABAOiECAACkEyIAAEA6IQIAAKQTIgAAQDohAgAApBMiAABA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9Ri7of+ECAAAkE6IQB/ZUQOoLmM49JcQgT4xgQFUn7Ec+keIAAAA6YQI9IEdNID6MKZDfwgR6DETFkD9GNuh94QIAACQTohAD9kxA6gvYzz0lhCBHjFBAdSfsR56R4gAAADphAj0gB0ygOYw5kNvCBFYJhMSQPMY+2H5hAgAAJBOiMAy2BEDaC5zACyPEIElMgEBYC6ApRMiAABAOiECS2AHDIBLzAmwNEIEFsmEA8C1zA2weEIEAABIJ0RgEex4AXAj5ghYHCECC2SCAWA+5gpYOCECAACkEyKwAHa4AFgocwYsjBCBeZhQAFgscwfMb3jQBwBl9/14bNCHAABQO+6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmECAAAkE6IAAAA6YQIAACQTogAAADphAgAAJBOiAAAAOmGIyJ2b2wN+jgAAIAG+f/bSmo4C4fjXQAAAABJRU5ErkJggg==" alt="Said lovely brown triangle"></p> <h2 id="sheder-のコンパイルと-include-spirv"><a href="#sheder-のコンパイルと-include-spirv" class="header-anchor">#</a> sheder のコンパイルと include_spirv</h2> <p>現時点ではシェーダーはプログラムの起動時にコンパイルしています。これは有効な方法ですが起動時にかなり時間がかかります。これは wgpu の <code>include_spirv</code> という便利なマクロを使い spirv コードを直接インライン化することで避けることもできます。これにより shaderc の依存を少なくともランタイムのコードからは取り除くことができます。</p> <p>build script を使うことができます。build script は cargo がプロジェクトをコンパイルするときに実行されるファイルです。これは shader のコンパイルを含むいろいろなものに使うことができます。</p> <p><code>build.rs</code> という名前のファイルを src ディレクトリと同じ階層に追加しましょう。これは <code>Cargo.toml</code> と同じフォルダという意味です。</p> <p>では少しコードを書きます。最初は <code>Cargo.toml</code> に追加します。</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">image</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.23&quot;</span>
<span class="token key property">winit</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.22&quot;</span>
<span class="token comment"># shaderc = &quot;0.6&quot; # REMOVED!</span>
<span class="token key property">cgmath</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.17&quot;</span>
<span class="token key property">wgpu</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.6&quot;</span>
<span class="token key property">futures</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.3&quot;</span>

<span class="token comment"># NEW!</span>
<span class="token punctuation">[</span><span class="token table class-name">build-dependencies</span><span class="token punctuation">]</span>
<span class="token key property">anyhow</span> <span class="token punctuation">=</span> <span class="token string">&quot;1.0&quot;</span>
<span class="token key property">fs_extra</span> <span class="token punctuation">=</span> <span class="token string">&quot;1.1&quot;</span>
<span class="token key property">glob</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.3&quot;</span>
<span class="token key property">shaderc</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.6&quot;</span>
</code></pre></div> <p>sharderc を dependencies から削除し、新しい <code>[build-depencies]</code> ブロックに追加します。これらは build script が依存するものです。shaderc についてはしてていますが、ほかのものはファイルシステムや rust のエラーをシンプルに扱うためのものです。</p> <p>これで <code>build.rs</code> にコードを書いていけます。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">glob<span class="token punctuation">::</span></span>glob<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token punctuation">{</span>read_to_string<span class="token punctuation">,</span> write<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>path<span class="token punctuation">::</span></span><span class="token class-name">PathBuf</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">ShaderData</span> <span class="token punctuation">{</span>
    src<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    src_path<span class="token punctuation">:</span> <span class="token class-name">PathBuf</span><span class="token punctuation">,</span>
    spv_path<span class="token punctuation">:</span> <span class="token class-name">PathBuf</span><span class="token punctuation">,</span>
    kind<span class="token punctuation">:</span> <span class="token namespace">shaderc<span class="token punctuation">::</span></span><span class="token class-name">ShaderKind</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">ShaderData</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">load</span><span class="token punctuation">(</span>src_path<span class="token punctuation">:</span> <span class="token class-name">PathBuf</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> extension <span class="token operator">=</span> src_path
            <span class="token punctuation">.</span><span class="token function">extension</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">&quot;File has no extension&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span>
            <span class="token punctuation">.</span><span class="token function">to_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">&quot;Extension cannot be converted to &amp;str&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> kind <span class="token operator">=</span> <span class="token keyword">match</span> extension <span class="token punctuation">{</span>
            <span class="token string">&quot;vert&quot;</span> <span class="token operator">=&gt;</span> <span class="token namespace">shaderc<span class="token punctuation">::</span></span><span class="token class-name">ShaderKind</span><span class="token punctuation">::</span><span class="token class-name">Vertex</span><span class="token punctuation">,</span>
            <span class="token string">&quot;frag&quot;</span> <span class="token operator">=&gt;</span> <span class="token namespace">shaderc<span class="token punctuation">::</span></span><span class="token class-name">ShaderKind</span><span class="token punctuation">::</span><span class="token class-name">Fragment</span><span class="token punctuation">,</span>
            <span class="token string">&quot;comp&quot;</span> <span class="token operator">=&gt;</span> <span class="token namespace">shaderc<span class="token punctuation">::</span></span><span class="token class-name">ShaderKind</span><span class="token punctuation">::</span><span class="token class-name">Compute</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token macro property">bail!</span><span class="token punctuation">(</span><span class="token string">&quot;Unsupported shader: {}&quot;</span><span class="token punctuation">,</span> src_path<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> src <span class="token operator">=</span> <span class="token function">read_to_string</span><span class="token punctuation">(</span>src_path<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> spv_path <span class="token operator">=</span> src_path<span class="token punctuation">.</span><span class="token function">with_extension</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;{}.spv&quot;</span><span class="token punctuation">,</span> extension<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">Self</span> <span class="token punctuation">{</span>
            src<span class="token punctuation">,</span>
            src_path<span class="token punctuation">,</span>
            spv_path<span class="token punctuation">,</span>
            kind<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Collect all shaders recursively within /src/</span>
    <span class="token comment">// 全ての src の shader を再帰的に集めます。</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> shader_paths <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">&quot;./src/**/*.vert&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span>
        <span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">&quot;./src/**/*.frag&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span>
        <span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">&quot;./src/**/*.comp&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// This could be parallelized</span>
    <span class="token comment">// ここは並列化できます。</span>
    <span class="token keyword">let</span> shaders <span class="token operator">=</span> shader_paths
        <span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>glob_result<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">ShaderData</span><span class="token punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span>glob_result<span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Result</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> compiler <span class="token operator">=</span> <span class="token namespace">shaderc<span class="token punctuation">::</span></span><span class="token class-name">Compiler</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to create shader compiler&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token comment">// This can't be parallelized. The [shaderc::Compiler] is not</span>
    <span class="token comment">// thread safe. Also, it creates a lot of resources. You could</span>
    <span class="token comment">// spawn multiple processes to handle this, but it would probably</span>
    <span class="token comment">// be better just to only compile shaders that have been changed</span>
    <span class="token comment">// recently.</span>
    <span class="token comment">// ここは並列化できません。[shaderc::Compiler] はスレッドセーフではありません。</span>
    <span class="token comment">// また、この crate は多くのリソースを必要とします。</span>
    <span class="token comment">// マルチプロセス化してやることもできますが、</span>
    <span class="token comment">// 多分直近で変更されたシェーダーだけをコンパイルするほうがマシです。</span>
    <span class="token keyword">for</span> shader <span class="token keyword">in</span> shaders <span class="token punctuation">{</span>
        <span class="token comment">// This tells cargo to rerun this script if something in /src/ changes.</span>
        <span class="token comment">// これは cargo に /src/ 以下に変更があった時にスクリプトを再実行することを伝えます。</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;cargo:rerun-if-changed={}&quot;</span><span class="token punctuation">,</span> shader<span class="token punctuation">.</span>src_path<span class="token punctuation">.</span><span class="token function">as_os_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">let</span> compiled <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">compile_into_spirv</span><span class="token punctuation">(</span>
            <span class="token operator">&amp;</span>shader<span class="token punctuation">.</span>src<span class="token punctuation">,</span>
            shader<span class="token punctuation">.</span>kind<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>shader<span class="token punctuation">.</span>src_path<span class="token punctuation">.</span><span class="token function">to_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span>
            <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token function">write</span><span class="token punctuation">(</span>shader<span class="token punctuation">.</span>spv_path<span class="token punctuation">,</span> compiled<span class="token punctuation">.</span><span class="token function">as_binary_u8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div> <p>これで <code>main.rs</code> の 2 つの行をコンパイルされた shader コードに置き換えることができます。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> vs_module <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_shader_module</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token macro property">include_spirv!</span><span class="token punctuation">(</span><span class="token string">&quot;shader.vert.spv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fs_module <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_shader_module</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token macro property">include_spirv!</span><span class="token punctuation">(</span><span class="token string">&quot;shader.frag.spv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="note"><p>build script の code について wgpu に関連したトピックにフォーカスして紹介しています。build script のデザインやそれ自身についてのトピックや、詳細についてはとても長い説明が必要です。ビルドスクリプトについて学びたいときには <a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html" target="_blank" rel="noopener noreferrer">The Cargo Book<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> を見るとよいでしょう。</p></div> <h2 id="challenge"><a href="#challenge" class="header-anchor">#</a> Challenge</h2> <p>もう一つパイプラインを作ってみましょう。トライアングルの位置から色を作りフラグメントシェーダーが使う f_color に指定してみましょう。そしてスペースキーを押すとパイプラインが切り替わるようにしてみましょう。ヒント:このシェーダーで <code>in</code> 変数と <code>out</code> 変数を使います。</p> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/beginner/tutorial3-pipeline/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">1/7/2021, 11:19:06 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/learn-wgpu/beginner/tutorial2-swapchain/" class="prev">
          The Swapchain
        </a></span> <span class="next"><a href="/learn-wgpu/beginner/tutorial4-buffer/">
          Buffers and Indices
        </a>
        →
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu/assets/js/app.b49cbda4.js" defer></script><script src="/learn-wgpu/assets/js/2.71b38626.js" defer></script><script src="/learn-wgpu/assets/js/12.0331fccb.js" defer></script><script src="/learn-wgpu/assets/js/22.2132e362.js" defer></script>
  </body>
</html>
